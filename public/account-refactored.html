<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title></title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
</head>

<body>
    <input type="file" id="file-input">
    <p id="status">Please select a file</p>
    <img id="preview" src="/images/default.png">

    <form method="POST" action="/save-details">
        <input type="hidden" id="avatar-url" name="avatar-url" value="/images/default.png">
        <input type="text" id="username" name="username" placeholder="Username"><br>
        <input type="text" name="full-name" placeholder="Full name"><br><br>
        <input type="submit" value="Update profile">
    </form>

    <script type="text/javascript">
            $(function(){

            (() => {
                $('#file-input').onchange = () => {
                    const files = $('#file-input').files;
                    const file = files[0];
                    if (file == null) {
                        return alert('No file selected.');
                    }
                    getSignedRequest(file);
                };
            })();

            function getSignedRequest(file) {
                $.get(`/upload/sign-s3?file-name=${file.name}&file-type=${file.type}`);
                $.onreadystatechange = () => {
                    if ($readyState === 4) {
                        if ($status === 200) {
                            uploadFile(file, response.signedRequest, response.url);
                        } else {
                            alert('Could not get signed URL.');
                        }
                    }
                };
                $.send();
            }

            function uploadFile(file, signedRequest, url) {
                $.ajax({
                  type: 'PUT',
                  username: $('#username').val,
                  video_url: file.body.video_url,
                  location: file.body.location
                }, signedRequest);
                success: $.onreadystatechange = () => {
                    if ($readyState === 4) {
                        if ($status === 200) {
                            $('#preview').src = url;
                            $('#avatar-url').val = url;
                        } else {
                            alert('Could not upload file.');
                        }
                    }
                };
                xhr.send(file);
            }
          })
          var obj = {
            username: req.body.username,
            video_url: req.body.video_url,
            location: req.body.location
          }
          $.put('/upload', obj, function(result) {
            $.ajax({
              type: 'PUT',
              success: function(){

              }
            })
          })
    </script>

</body>

</html>
